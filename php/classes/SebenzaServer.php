<?php
/**
 * Created by PhpStorm
 * Date: 2016/02/15
 * Time: 1:16 AM
 */
include_once $_SERVER['DOCUMENT_ROOT']."/php/classes/Session.php";
include_once $_SERVER['DOCUMENT_ROOT'] . "/php/classes/DatabaseHandler.php";
class SebenzaServer {
    public static function start() {
        //Used in open-html.php and AJAX handling below
        //Start output buffering - server only sends the output once per page vs for every "echo" or "print" command
        ob_start();
        //Set the server's default timezone - time is important for many of php's functions
        if (date_default_timezone_get()!=="Africa/Johannesburg") {
            date_default_timezone_set("Africa/Johannesburg");
        }
    }

    public static function stop() {
        //Used in close-html.php and AJAX handling below
        //Flush the output buffer - send all the output generated by the server to the client now
        ob_end_flush();
    }

    public static function login($username, $password):bool {
        //Assume failure
        $successfulLogin = false;
        //Validate the function's arguments
        if (is_string($username) && is_string($password)) {
            //Get an instance of the database and session handlers
            $dbHandler = self::fetchDatabaseHandler();
            $sessionHandler = self::fetchSessionHandler();
            //Fetch the relevant user's data
            $dbHandler->runCommand("SELECT `Password`,`UserID`,`Username`,`TypeOfUser`,`Confirmation` FROM REGISTERED_USER WHERE `Username` = ?", $username);
            $result = $dbHandler->getResults();
            //If a single result was returned and the password matches the hashed password stored in the database
            if (count($result) == 1 && password_verify($password, $result[0]['Password'])) {
                //Mark success
                $successfulLogin = true;
                //Set any variables you want access to in the session
                $sessionHandler->setSessionVariable("UserID",$result[0]['UserID']);
                $sessionHandler->setSessionVariable("Username", $result[0]['Username']);
                $sessionHandler->setSessionVariable("UserType", $result[0]['TypeOfUser']);
                $sessionHandler->setSessionVariable("UserConfirmation", $result[0]['Confirmation']);
            }
        }
        return $successfulLogin;
    }

    //Due to this function relying on redirect, it must happen in the beginning of the open-html.php file too.
    public static function logout() {
        //Clear and end the current session
        self::fetchSessionHandler()->endSession();
    }

    //This must be called before any output is sent to the client, so in the beginning of the open-html.php file.
    public static function redirect($url) {
        if (is_string($url)) {
            //Redirect the server
            header("Location: " . $url);
            //End script execution of current page
            exit(0);
        }
    }

    public static function fetchDatabaseHandler():DatabaseHandler {
        $session = self::fetchSessionHandler();
        if ($session->exists("dbHandler")) {
            $dbHandler = $session->getSessionVariable("dbHandler");
        } else {
            $dbHandler = new DatabaseHandler("localhost","root","Sebenza","SebenzaSA_Database");
            $session->setSessionVariable("dbHandler", $dbHandler);
        }
        return $dbHandler;
    }

    public static function createAndResetDatabase():bool {
        $dbHandler = new DatabaseHandler("localhost","root","Sebenza","");
        $success = $dbHandler->executeSQLScriptFile("database/SebenzaSA_Database.sql");
        self::fetchSessionHandler()->setSessionVariable("dbHandler", $dbHandler);
        return $success;
    }

    public static function fetchSessionHandler():Session {
        $session = new Session();
        if ($session->exists('sessionHandler')) {
            $session = $session->getSessionVariable('sessionHandler');
        } else {
            $session->setSessionVariable('sessionHandler', $session);
        }
        return $session;
    }

    public static function hashPassword($password):string {
        return password_hash($password,PASSWORD_DEFAULT);
    }
    
    public static function addNotification($userID, $message):bool {
        $returnValue = false;
        if (is_int($userID) && is_string($message)) {
            $dbHandler = self::fetchDatabaseHandler();
            $command = "INSERT INTO `NOTIFICATION` (`UserID`,`Message`) VALUES (?, ?)";
            $returnValue = $dbHandler->runCommand($command, $userID, $message);
        }
        return $returnValue;
    }

    public static function pullNotifications():array {
        $returnValue = array();
        if (self::fetchSessionHandler()->exists('UserID')) {
            $uid = self::fetchSessionHandler()->getSessionVariable('UserID');
            $command = "SELECT `NotificationID`,`Message` FROM `NOTIFICATION` WHERE `UserID` = ? AND `Pulled` = false AND `Pushed` = false AND `Expired` = false";
            $dbHandler = self::fetchDatabaseHandler();
            if ($dbHandler->runCommand($command, $uid)) {
                $results = $dbHandler->getResults();
                if (count($results) > 0) {
                    foreach ($results as $result) {
                        $returnValue[] = $result['Message'];
                        $dbHandler->runCommand("UPDATE `NOTIFICATION` SET `Pulled` = true WHERE `NotificationID` = ?", $result['NotificationID']);
                    }
                }
            }
        }
        return $returnValue;
    }
    /*The following function will register the user according to his type, confirmation of email will be required from all
    users, to ensure that the email account exists.*/
    public static function register(array $input, $type){
        //TODO: Order the thing in such a way that it will not remove entries already removed etc, so remove the condition variables and add what is to be done at the end of the for loops last run instead.
        $locationsToRemove = 0;
        $locationsPerUserToRemove = 0;
        $skillsPerUserToRemove = 0;
        //should be an integer that will never exist within the database
        $id = -5;
        $email = $input[1];
        $username = $input[0];
        $keyToSend = self::hashPassword($email + $username + time());
        $numLocations = $input[6];
        $numSkills = $input[9];
        $locationID = array($numLocations);
        $locationsToRemove = array($numLocations);
        $locationsToRemoveAmount = 0;
        //$condition = self::mailClient($email,$keyToSend,$input);
        $condition = true;
        $test = "";
        $returnValue = "";
       if($condition)
            switch ($type){
                case 'contractor':
                    $test .= "Working with contractor";
                    $command = "SELECT `locationID`,`locationName` FROM `LOCATIONS` WHERE `locationName` = ?";
                    $command1 = "INSERT INTO `LOCATIONS` (`locationName`, `Coordinates`, `Region`, `Province`, `City`) VALUES (?,?,?,?,?)";
                    $dbHandler = self::fetchDatabaseHandler();
                    //The following will run through all the areas added by the contractor and areas which don't exist will be added to the database, consider having an admin accept and reject areas according to a standard
                    $condition = true;
                    $region = "A";
                    $coordinates = "0:0";
                    $returnValue = $test;
                    for($k = 0; (($k < $numLocations) && $condition);$k++){
                        if($dbHandler->runCommand($command,$_POST["areaname-contractor-".$k])) {
                            $test .= " Running through areas: ";
                            //Should always return true, even if a matching area is not found, then that area will be added.
                            $result = $dbHandler->getResults();
                            if (count($result) == 0) {
                                //If the area does not exist in the database add it and gain a handle on the id
                                $area = $_POST["areaname-contractor-".$k];
                                $province = $_POST["provincename-contractor-".$k];
                                $city = $_POST["cityname-contractor-".$k];
                                //TODO: coordinates can be requested through google maps api - extra
                                if($dbHandler->runCommand($command1, $area, $coordinates, $region, $province, $city)){
                                    $locationID[$k] = $dbHandler->getInsertID();
                                    $locationsToRemove[$locationsToRemoveAmount++] = $dbHandler->getInsertID();
                                }
                                else{
                                    $test .= "no locations added from k =".$k;
                                    $k = $numLocations + 5;
                                    $condition = false;
                                    //dbhandler has failed to run for some reason remove all locations added to LOCATIONS
                                }

                            } else {
                                //If the area exists in the database gain a handle on the areaID - there should only be one returned result as the area names should be unique
                                $locationID[$k] = $result['locationID'];
                            }
                        }
                        else{
                            //dbhandler has failed to run for some reason remove all locations added to LOCATIONS if any
                            $test .= "Couldnt run dbhandler to locate areas";
                            $locationsToRemove = $k - 1;
                            $k = $numLocations + 5;
                            $condition = false;
                        }
            }
                    //Due to LOCATIONS having multiple inserts which run in a for loop $condition exists, can be done when the for loop reaches the last position.
                    if($condition){
                        $command = "INSERT INTO `REGISTERED_USER` (`Username`, `Email`, `ContactNumber`, `TypeOfUser`, `Password`, `Surname`, `Name`) VALUES (?,?,?,?,?,?,?)";
                        $contactNumber = $input[2];
                        $password = self::hashPassword($input[3]);
                        $name = $input[5];
                        $surname = $input[4];
                        if ($dbHandler->runCommand($command, $username, $email, $contactNumber, 1, $password, $surname, $name)) {
                            //once users are inserted into the REGISTERED_USER table appropriate data will be inserted into the CONFIRMATIONS table
                            $id = $dbHandler->getInsertID();
                            $command = "INSERT INTO `CONFIRMATIONS` (`UserID`, `Key`) VALUES (?,?)";
                            if( $dbHandler->runCommand($command, $id, $keyToSend)){
                                //once users are inserted into the CONFIRMATIONS table appropriate data will be inserted into the CONTRACTOR table
                                //TODO: Add in the BusinessDescription,BusinessHours,Availability text areas to be added to the database
                                $busName = $input[7];
                                $busAddress = $input[8];
                                //The following is to check whether the contractor is VAT registered or not
                                if($_POST['ignore-exampleSwitch'] == "on") {
                                    //This will insert into the database taking into account the business is - VAT registered
                                    $command = "INSERT INTO `CONTRACTOR` (`UserID`, `BusinessRegistrationNum`, `BusinessVatNum`, `BusinessAddress`, `BusinessName`) VALUES (?,?,?,?,?)";
                                    if($dbHandler->runCommand($command,$id,$_POST['reg-contractor'],$_POST['vat-contractor'],$busAddress,$busName)){
                                        $condition2 = true;
                                        $command = "INSERT INTO `SPECIALIZATIONS_PER_USER` (`UserID`, `workTypeID`) VALUES (?,?)";
                                        for($j = 0; (($j < $numSkills) && $condition);$j++){
                                            if($dbHandler->runCommand($command,$id,$_POST['contractor-work-type-'.$j])){

                                            }
                                            else{
                                                $condition = false;
                                            }
                                        }
                                        if($condition){
                                            //TODO:insert locations into LOCATIONS_PER_USER
                                            $command = "INSERT INTO `LOCATIONS_PER_USER` (`UserID`, `locationID`) VALUES (?,?)";
                                            for($k = 0;$k<$numLocations && $condition;$k++){
                                                $returnValue = $dbHandler->runCommand($command,$id,$locationID[$k]);
                                                if($returnValue){

                                                }
                                                else{
                                                    //TODO:remove inserted elements from LOCATIONS,REGISTERED_USER,CONFIRMATIONS,SPECIALIZATIONS_PER_USER,LOCATIONS_PER_USER and set $returnValue to false
                                                    $condition = false;
                                                }
                                            }
                                            if(!$condition){
                                                //TODO:remove all LOCATIONS,REGISTERED_USER,CONFIRMATIONS,LOCATIONS_PER_USER,SPECIALIZATIONS_PER_USER and set $returnValue to false
                                            }
                                        }
                                        else{
                                            //TODO:remove inserted elements from LOCATIONS,REGISTERED_USER,CONFIRMATIONS,SPECIALIZATIONS_PER_USER and set $returnValue to false
                                        }

                                        }
                                    else{
                                        //TODO:remove inserted elements from LOCATIONS,REGISTERED_USER,CONFIRMATIONS and set $returnValue to false
                                    }
                                }
                                else{
                                    //This will insert into the database taking into account the business is not - VAT registered
                                    $command = "INSERT INTO `CONTRACTOR` (`UserID`, `BusinessAddress`, `BusinessName`) VALUES (?,?,?)";
                                    if($dbHandler->runCommand($command,$id,$busAddress,$busName)){
                                        $command = "INSERT INTO `SPECIALIZATIONS_PER_USER` (`UserID`, `workTypeID`) VALUES (?,?)";
                                        for($j = 0; ($j < $numSkills) && $condition;$j++){
                                            if($dbHandler->runCommand($command,$id,$_POST['contractor-work-type-'.$j])){

                                            }
                                            else{
                                                $condition = false;
                                            }
                                        }
                                        if($condition){
                                            //TODO:insert locations into LOCATIONS_PER_USER
                                            $command = "INSERT INTO `LOCATIONS_PER_USER` (`UserID`, `locationID`) VALUES (?,?)";
                                            for($k = 0;$k<$numLocations && $condition;$k++){
                                                $returnValue = $dbHandler->runCommand($command,$id,$locationID[$k]);
                                                if($returnValue){

                                                }
                                                else{
                                                    $condition = false;
                                                }
                                            }
                                            if(!$condition){
                                                //TODO:remove all LOCATIONS,REGISTERED_USER,CONFIRMATIONS,LOCATIONS_PER_USER,SPECIALIZATIONS_PER_USER and set $returnValue to false
                                            }
                                        }
                                        else{
                                            //TODO:remove inserted elements from LOCATIONS,REGISTERED_USER,CONFIRMATIONS,SPECIALIZATIONS_PER_USER and set $returnValue to false
                                        }

                                    }
                                    else{
                                        //TODO:remove inserted elements from LOCATIONS,REGISTERED_USER,CONFIRMATIONS and set $returnValue to false - correct
                                    }
                                }
                            }
                            else{
                                //TODO:remove inserted elements from LOCATIONS,REGISTERED_USER and set $returnValue to false - correct
                            }
                            //TODO: A timer could run to check the date since the email was sent so that if confirmation doesn't occur within a month or two the entry in the database can be removed for username recycling purposes and so that the database doesn't get full with unnecessary entries
                        }
                    }
                    else{
                        //TODO:remove inserted elements from LOCATIONS and set $returnValue to false - correct
                        $returnValue = $test;
                    }
                    return "This is a test";
                    break;
                case 'homeuser':
                    $command = "INSERT INTO `REGISTERED_USER` (`Username`, `Email`, `ContactNumber`, `TypeOfUser`, `Password`, `Surname`, `Name`) VALUES (?,?,?,?,?,?,?)";
                    $contactNumber = $input[2];
                    $password = self::hashPassword($input[3]);
                    $name = $input[5];
                    $surname = $input[4];
                    $dbHandler = self::fetchDatabaseHandler();
                    if($dbHandler->runCommand($command,$username,$email,$contactNumber,2,$password,$surname,$name)){
                        $id = $dbHandler->getInsertID();
                        $command = "INSERT INTO `CONFIRMATIONS` (`UserID`, `Key`) VALUES (?,?)";
                        $returnValue = $dbHandler->runCommand($command,$id,$keyToSend);
                        //A timer could run to check the date since the email was sent so that if confirmation doesn't occur within a month or two the entry in the database can be removed for username recycling purposes and so that the database doesn't get full with unnecessary entries
                    }
                    return $returnValue;
                    break;
                case 'tradeworker':
                    $command = "INSERT INTO `REGISTERED_USER` (`Username`, `Email`, `ContactNumber`, `TypeOfUser`, `Password`, `Surname`, `Name`) VALUES (?,?,?,?,?,?,?)";
                    $contactNumber = $input[2];
                    $password = self::hashPassword($input[3]);
                    $name = $input[5];
                    $surname = $input[4];
                    $dbHandler = self::fetchDatabaseHandler();
                    if($dbHandler->runCommand($command,$username,$email,$contactNumber,0,$password,$surname,$name)){
                        $id = $dbHandler->getInsertID();
                        $command = "INSERT INTO `CONFIRMATIONS` (`UserID`, `Key`) VALUES (?,?)";
                        $returnValue = $dbHandler->runCommand($command,$id,$keyToSend);
                        //A timer could run to check the date since the email was sent so that if confirmation doesn't occur within a month or two the entry in the database can be removed for username recycling purposes and so that the database doesn't get full with unnecessary entries
                    }
                    return $returnValue;
                    break;
                default:
                    return $returnValue;
                    break;
            }
        return $returnValue;
    }

    public static function mailClient($to,$key):bool{
        require $_SERVER['DOCUMENT_ROOT'] ."/php/externalClasses/PHPMailer-master/PHPMailer-master/PHPMailerAutoload.php";
        $mail = new PHPMailer;

        //$mail->SMTPDebug = 3;                               // Enable verbose debug output
        $link = "http://localhost:31335/index.php?email=".$to."&key=".$key;
        $title = "Sebenza South Africa";
        $mail->isSMTP();                                      // Set mailer to use SMTP
        $mail->Host = 'smtp.gmail.com';  // Specify main and backup SMTP servers
        $mail->SMTPAuth = true;                               // Enable SMTP authentication
        $mail->Username = '215040496@student.uj.ac.za';                 // SMTP username
        $mail->Password = '@Uj-436518';                           // SMTP password
        $mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
        $mail->Port = 587;                                    // TCP port to connect to
        $mail->IsHTML(true);
        $mail->setFrom('215040496@student.uj.ac.za', 'Mailer');
        $mail->addAddress($to, 'Joe User');       // Name is optional
        $mail->addReplyTo('215040496@student.uj.ac.za', 'Information');

        $mail->Subject = 'SebenzaSA Confirmation';
        $mail->Body    = 'This is the HTML message body <b>in bold!</b><br/><a href="'.$link.'">'.$title.'</a>';
        return $mail->send();
    }
    //The following function is used to confirm a user who has clicked on the link within an email he received
    public static function userConfirm($email,$key):bool{
        $returnValue = false;
        $command = "SELECT `UserID`,`Confirmation` FROM `REGISTERED_USER` WHERE `Email` = ?";
        $dbhandler = self::fetchDatabaseHandler();
        //Check whether the email exists within the database
        if($dbhandler->runCommand($command,$email)){
            $results = $dbhandler->getResults();

            //Check whether the user has been confirmed or not
            if(count($results)> 0)
                if(!$results[0]['Confirmation']){
                    $command = "SELECT `Key` FROM `CONFIRMATIONS` WHERE `UserID` = ?";
                    //Retrieve the key associated with the user upon the account registration
                    if($dbhandler->runCommand($command,$results[0]['UserID'])) {
                        $storedKey = $dbhandler->getResults();
                        //Test whether the keys from database and from email are the same value
                        if ($storedKey[0]["Key"] === $key) {
                            $command = "UPDATE `REGISTERED_USER` SET `Confirmation` = TRUE WHERE `UserID`=?";
                            //Set the confirmation to true
                            if ($dbhandler->runCommand($command, $results[0]['UserID'])) {
                                //Delete the entry required to test confirmation
                                if($dbhandler->runCommand("DELETE FROM `CONFIRMATIONS` WHERE `UserID` = ?", $results[0]['UserID'])){
                                    $returnValue = true;
                                }
                            }
                        }
                    }
                }
        }
        return $returnValue;
    }

    public static function returnWorkTypes() {
        $dbhandler = self::fetchDatabaseHandler();
        $command = "Select `WorkType`,`workTypeID` FROM SPECIALIZATIONS";
        $dbhandler->runCommand($command);
        $results = $dbhandler->getResults();
        return $results;
    }
}
//The following is currently used to receive the confirmation requests from the user
if (!empty($_GET)){
    if(isset($_GET['email']) && isset($_GET['key'])){
        //If this returns false one could log the false returns to see if unwanted entry into the server occurred
            $result = SebenzaServer::userConfirm($_GET['email'],$_GET['key']);

        if($result){
            SebenzaServer::logout();
        }
        //Email link e.g. localhost:31335/index.php?email="teat@test.com"&key="test"
    }
}


//The following code handles ajax requests sent to SessionModule.php as in sebenza.js for the login functionality
if (!empty($_POST)) {
    //Synchronise the time and start output buffering (an AJAX request can happen separate from an official page load)
    SebenzaServer::start();
    //AJAX requests are served some sort of textual response (usually JSON for easier handling by JavaScript)
    $response = "";
    if (isset($_POST['action'])) {
        $action = $_POST['action'];
        switch ($action) {
            case 'fetch_notifications':
                $response = json_encode(SebenzaServer::pullNotifications());
                break;
            case 'login':
                if (isset($_POST['username']) && isset($_POST['password'])) {
                    $response = json_encode(SebenzaServer::login($_POST['username'], $_POST['password']));
                } else {
                    $response = json_encode(false);
                }
                break;
            case 'logout':
                $response = json_encode(true);
                SebenzaServer::logout();
                break;
            case 'register-contractor':
                //Ensure all skill are set
                $condition = true;
                if(isset($_POST['ignore-sillsAdded-contractor'])){
                    for($k = 0; $k < $_POST['ignore-sillsAdded-contractor'];$k++){
                        if(!isset($_POST['contractor-work-type-'.$k])){
                            $condition = false;
                        }
                    }
                }
                else {
                    $condition = false;
                }


                //Ensure all locations are set
                if(isset($_POST['ignore-locationsAdded-contractor'])){
                    for($k = 0; $k < $_POST['ignore-locationsAdded-contractor'];$k++){
                        if(!isset($_POST['areaname-contractor-'.$k])){
                            $condition = false;
                        }
                        if(!isset($_POST['cityname-contractor-'.$k])){
                            $condition = false;
                        }
                        if(!isset($_POST['provincename-contractor-'.$k])){
                            $condition = false;
                        }
                        //$test .= $_POST['provincename-contractor-'.$k]." ".$_POST['cityname-contractor-'.$k]." ".$_POST['areaname-contractor-'.$k]." ";
                    }
                }
                else{
                    $condition = false;
                }

                //Ensure that if the business is VAT registered to store appropriate details like the business registration number and the business's vat number
                if(isset($_POST['ignore-exampleSwitch'])) {
                    if($_POST['ignore-exampleSwitch'] == "on"){
                        //TODO: not 100% sure on this if statement must definitely test it
                        if(!isset($_POST['reg-contractor']) || !isset($_POST['vat-contractor']) ) {
                            $condition = false;
                        }

                    }
                }
                else{
                    $condition = false;
                }


                //$test .= " ".$_POST['ignore-sillsAdded-contractor']." ".$_POST['ignore-locationsAdded-contractor']." ".$_POST['ignore-exampleSwitch']." ";
                //Ensure all the rest of the variables are set
                if($condition) {
                    if (isset($_POST['name-contractor']) && isset($_POST['surname-contractor']) && isset($_POST['username-contractor']) && isset($_POST['password-contractor']) && isset($_POST['confirmPassword-contractor']) && isset($_POST['email-contractor']) && isset($_POST['confirmEmail-contractor']) && isset($_POST['cellnumber-contractor']) && isset($_POST['homeNumber-contractor']) && isset($_POST['busName']) && isset($_POST['address-contractor']) && isset($_POST['areaname-contractor-0']) && isset($_POST['cityname-contractor-0']) && isset($_POST['provincename-contractor-0'])) {
                        //$response = json_encode(SebenzaServer::register([$_POST['username-contractor'], $_POST['email-contractor'], $_POST['cellnumber-contractor'], $_POST['password-contractor'], $_POST['surname-contractor'], $_POST['name-contractor'], $_POST['ignore-locationsAdded-contractor'],$_POST['busName'],$_POST['address-contractor'],$_POST['ignore-sillsAdded-contractor']], 'contractor'));
                        $response = json_encode("It got here");
                    } else {
                        $response = json_encode(false);
                    }
                }
                else{
                    $response = json_encode(false);
                }
                break;
            case 'register-tradeworker':
                if(isset($_POST['username']) && isset($_POST['name']) && isset($_POST['surname']) && isset($_POST['password']) && isset($_POST['email']) && isset($_POST['cellnumber']) && isset($_POST['homeNumber'])){
                    $response = json_encode(SebenzaServer::register([$_POST['username'],$_POST['email'],$_POST['cellnumber'],$_POST['password'],$_POST['surname'],$_POST['name']],'tradeworker'));
                } else{
                    $response = json_encode(false);
                }
                break;
            case 'register-homeuser':
                if(isset($_POST['username']) && isset($_POST['name']) && isset($_POST['surname']) && isset($_POST['password']) && isset($_POST['email']) && isset($_POST['cellnumber']) && isset($_POST['homeNumber'])){
                    $response = json_encode(SebenzaServer::register([$_POST['username'],$_POST['email'],$_POST['cellnumber'],$_POST['password'],$_POST['surname'],$_POST['name']],'homeuser'));
                } else{
                    $response = json_encode(false);
                }
                break;
            case 'fetch_work_types':
                $response = json_encode(SebenzaServer::returnWorkTypes());
                break;
            default:
                //If the action was not one of the handled cases, respond appropriately
                $response = json_encode("Request not recognised.");
                break;
        }
    }
    echo $response;
    //Flush the output buffer
    SebenzaServer::stop();
}